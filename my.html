<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息 - 校园植被身份证</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        .avatar-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #e2e8f0;
            transition: all 0.3s ease;
            background-color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
        }

        .avatar-upload:hover .avatar-preview {
            border-color: #2E7D32;
            transform: scale(1.05);
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .avatar-upload:hover .avatar-overlay {
            opacity: 1;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2E7D32;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .btn-primary {
            background-color: #2E7D32;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background-color: #1b5e20;
        }

        .btn-secondary {
            background-color: #f1f5f9;
            color: #475569;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background-color: #e2e8f0;
        }

        .stats-card {
            background: linear-gradient(135deg, #2E7D32, #4CAF50);
            color: white;
            border-radius: 12px;
            padding: 20px;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .role-super-admin {
            background-color: #7c2d12;
            color: white;
        }

        .role-admin {
            background-color: #dc2626;
            color: white;
        }

        .role-user {
            background-color: #3b82f6;
            color: white;
        }

        .tab-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }

        .tab-button.active {
            background-color: #2E7D32;
            color: white;
        }

        .tab-button:not(.active):hover {
            background-color: #f1f5f9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-table th, .user-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .user-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #475569;
        }

        .user-table tr:hover {
            background-color: #f8fafc;
        }

        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .success-message.show {
            transform: translateX(0);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .avatar-placeholder {
            font-size: 48px;
        }
    </style>
</head>
<body>
<!-- 导航栏 -->
<header class="bg-white shadow-sm py-4">
    <div class="profile-container px-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <a href="index.html" class="flex items-center">
                <i class="fa fa-leaf text-2xl text-green-600 mr-2"></i>
                <span class="text-xl font-bold text-gray-800">校园植被身份证</span>
            </a>
        </div>
        <div class="flex items-center space-x-4">
            <a href="index.html" class="text-gray-600 hover:text-green-600 transition-colors">
                <i class="fa fa-home mr-1"></i> 返回主页
            </a>
            <button id="logoutBtn" class="text-gray-600 hover:text-red-600 transition-colors">
                <i class="fa fa-sign-out mr-1"></i> 退出登录
            </button>
        </div>
    </div>
</header>

<div class="profile-container px-4 py-8">
    <div class="flex flex-col md:flex-row gap-8">
        <!-- 左侧边栏 -->
        <div class="md:w-1/4">
            <div class="card p-6 mb-6">
                <div class="flex flex-col items-center mb-6">
                    <div class="avatar-upload mb-4">
                        <div id="avatarPreview" class="avatar-preview">
                            <i class="fa fa-user avatar-placeholder"></i>
                        </div>
                        <div class="avatar-overlay">
                            <i class="fa fa-camera text-white text-xl"></i>
                        </div>
                        <input type="file" id="avatarInput" accept="image/*" class="hidden">
                    </div>
                    <h2 id="userName" class="text-xl font-bold text-gray-800">加载中...</h2>
                    <div id="userRole" class="role-badge role-user mt-2">加载中...</div>
                </div>

                <div class="space-y-2">
                    <div class="tab-button active" data-tab="profile">
                        <i class="fa fa-user mr-2"></i> 个人信息
                    </div>
                    <div class="tab-button" data-tab="security">
                        <i class="fa fa-lock mr-2"></i> 账户安全
                    </div>
                    <div id="adminTab" class="tab-button" data-tab="admin" style="display: none;">
                        <i class="fa fa-users-cog mr-2"></i> 用户管理
                    </div>
                </div>
            </div>

            <div class="stats-card">
                <h3 class="font-bold text-lg mb-4">我的统计</h3>
                <div class="space-y-4">
                    <div>
                        <div class="text-2xl font-bold" id="plantsAdded">0</div>
                        <div class="text-green-100">添加的植物</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold" id="lastLogin">-</div>
                        <div class="text-green-100">最后登录</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧内容区域 -->
        <div class="md:w-3/4">
            <!-- 个人信息标签页 -->
            <div id="profileTab" class="tab-content active">
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">个人信息</h2>

                    <form id="profileForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                                <input type="text" id="fullName" class="form-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                                <input type="text" id="username" class="form-input" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">邮箱</label>
                                <input type="email" id="email" class="form-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">手机号</label>
                                <input type="tel" id="phone" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">部门/学院</label>
                                <input type="text" id="department" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">学号/工号</label>
                                <input type="text" id="studentId" class="form-input">
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">个人简介</label>
                            <textarea id="bio" class="form-input" rows="4"></textarea>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancelProfile" class="btn-secondary">取消</button>
                            <button type="submit" class="btn-primary">保存更改</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 账户安全标签页 -->
            <div id="securityTab" class="tab-content">
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">账户安全</h2>

                    <form id="passwordForm">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">当前密码</label>
                            <input type="password" id="currentPassword" class="form-input" required>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">新密码</label>
                            <input type="password" id="newPassword" class="form-input" required>
                            <p class="text-xs text-gray-500 mt-1">密码至少8位，包含字母和数字</p>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">确认新密码</label>
                            <input type="password" id="confirmPassword" class="form-input" required>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancelPassword" class="btn-secondary">取消</button>
                            <button type="submit" class="btn-primary">更改密码</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 用户管理标签页 (仅管理员可见) -->
            <div id="adminTabContent" class="tab-content">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">用户管理</h2>
                        <button id="addUserBtn" class="btn-primary">
                            <i class="fa fa-plus mr-2"></i> 添加用户
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="user-table">
                            <thead>
                            <tr>
                                <th>用户名</th>
                                <th>姓名</th>
                                <th>邮箱</th>
                                <th>角色</th>
                                <th>注册时间</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="userTableBody">
                            <!-- 用户数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 成功提示消息 -->
<div id="successMessage" class="success-message">
    <i class="fa fa-check-circle mr-2"></i>
    <span id="successText">操作成功！</span>
</div>

<!-- 添加用户模态框 -->
<div id="addUserModal" class="modal-overlay">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">添加用户</h3>
            <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                <i class="fa fa-times"></i>
            </button>
        </div>

        <form id="addUserForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                    <input type="text" id="newUsername" class="form-input" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                    <input type="text" id="newFullName" class="form-input" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">邮箱</label>
                    <input type="email" id="newEmail" class="form-input" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">初始密码</label>
                    <input type="password" id="newPassword" class="form-input" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">角色</label>
                    <select id="newRole" class="form-input">
                        <option value="user">普通用户</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" id="cancelAddUser" class="btn-secondary">取消</button>
                <button type="submit" class="btn-primary">添加用户</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Supabase配置
    const SUPABASE_URL = 'https://twzpessassvmnnbrnegd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnd2J6dHVpenhvd2lhY3B3em15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMzIyMDYsImV4cCI6MjA3OTkwODIwNn0.js6fUBJ9FGRMkVgp80Q-8D6hX-xXbr29rWKyJgOA9b4';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 用户数据
    let userData = {
        id: 1,
        username: '',
        fullName: '',
        email: '',
        phone: '',
        department: '',
        studentId: '',
        bio: '',
        role: 'user',
        avatar: '',
        plantsAdded: 0,
        lastLogin: ''
    };

    // 用户列表数据 (仅管理员可见)
    let usersData = [];

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        // 从localStorage获取当前用户信息
        const currentUser = localStorage.getItem('currentUser');
        const userRole = localStorage.getItem('userRole');

        if (!currentUser) {
            alert('请先登录！');
            window.location.href = 'login.html';
            return;
        }

        // 加载用户数据
        loadUserData(currentUser, userRole);

        // 设置标签页切换
        setupTabs();

        // 设置头像上传
        setupAvatarUpload();

        // 设置表单提交
        setupForms();

        // 设置按钮事件
        setupButtons();
    });

    // 从Supabase获取用户数据
    async function fetchUserData(username) {
        try {
            const { data: user, error } = await supabase
                .from('users')
                .select('*')
                .eq('username', username)
                .single();

            if (error) throw error;
            return user;
        } catch (error) {
            console.error('获取用户数据失败:', error);
            return null;
        }
    }

    // 从Supabase获取所有用户数据（管理员用）
    async function fetchAllUsers() {
        try {
            const { data: users, error } = await supabase
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;
            return users || [];
        } catch (error) {
            console.error('获取用户列表失败:', error);
            return [];
        }
    }

    // 更新用户信息到Supabase
    async function updateUserProfile(userData) {
        try {
            const { data, error } = await supabase
                .from('users')
                .update({
                    full_name: userData.fullName,
                    email: userData.email,
                    phone: userData.phone,
                    department: userData.department,
                    student_id: userData.studentId,
                    bio: userData.bio,
                    avatar: userData.avatar,
                    updated_at: new Date().toISOString()
                })
                .eq('username', userData.username)
                .select();

            if (error) throw error;
            return data[0];
        } catch (error) {
            console.error('更新用户信息失败:', error);
            throw error;
        }
    }

    // 修改密码
    async function updateUserPassword(username, currentPassword, newPassword) {
        try {
            // 首先验证当前密码
            const { data: user, error: verifyError } = await supabase
                .from('users')
                .select('password')
                .eq('username', username)
                .eq('password', currentPassword)
                .single();

            if (verifyError) throw new Error('当前密码不正确');

            // 更新密码
            const { error } = await supabase
                .from('users')
                .update({
                    password: newPassword,
                    updated_at: new Date().toISOString()
                })
                .eq('username', username);

            if (error) throw error;
            return true;
        } catch (error) {
            console.error('修改密码失败:', error);
            throw error;
        }
    }

    // 添加新用户
    async function addNewUser(userData) {
        try {
            // 检查用户名是否已存在
            const { data: existingUser, error: checkError } = await supabase
                .from('users')
                .select('username')
                .eq('username', userData.username)
                .single();

            if (existingUser) {
                throw new Error('用户名已存在');
            }

            const { data, error } = await supabase
                .from('users')
                .insert([{
                    username: userData.username,
                    password: userData.password,
                    full_name: userData.fullName,
                    email: userData.email,
                    role: userData.role,
                    created_at: new Date().toISOString()
                }])
                .select();

            if (error) throw error;
            return data[0];
        } catch (error) {
            console.error('添加用户失败:', error);
            throw error;
        }
    }

    // 更新用户角色
    async function updateUserRole(userId, newRole) {
        try {
            const { error } = await supabase
                .from('users')
                .update({
                    role: newRole,
                    updated_at: new Date().toISOString()
                })
                .eq('id', userId);

            if (error) throw error;
            return true;
        } catch (error) {
            console.error('更新用户角色失败:', error);
            throw error;
        }
    }

    // 删除用户
    async function deleteUserFromSupabase(userId) {
        try {
            const { error } = await supabase
                .from('users')
                .delete()
                .eq('id', userId);

            if (error) throw error;
            return true;
        } catch (error) {
            console.error('删除用户失败:', error);
            throw error;
        }
    }

    // 获取用户添加的植物数量
    async function getUserPlantsCount(username) {
        try {
            const { data: plants, error } = await supabase
                .from('plants')
                .select('id')
                .eq('created_by', username);

            if (error) throw error;
            return plants ? plants.length : 0;
        } catch (error) {
            console.error('获取植物数量失败:', error);
            return 0;
        }
    }

    // 加载用户数据
    async function loadUserData(username, role) {
        try {
            const userFromDB = await fetchUserData(username);

            if (userFromDB) {
                // 获取用户添加的植物数量
                const plantsCount = await getUserPlantsCount(username);

                // 使用数据库中的用户数据
                userData = {
                    id: userFromDB.id,
                    username: userFromDB.username,
                    fullName: userFromDB.full_name || '用户 ' + userFromDB.username,
                    email: userFromDB.email || userFromDB.username + '@campus.edu',
                    phone: userFromDB.phone || '13800138000',
                    department: userFromDB.department || '计算机学院',
                    studentId: userFromDB.student_id || '2023001001',
                    bio: userFromDB.bio || '热爱植物，喜欢探索校园中的各种植被。',
                    role: userFromDB.role,
                    avatar: userFromDB.avatar || '',
                    plantsAdded: plantsCount,
                    lastLogin: userFromDB.last_login ? new Date(userFromDB.last_login).toLocaleDateString() : new Date().toLocaleDateString()
                };
            } else {
                // 使用默认数据
                const isSuperAdmin = username === 'admin' && (role === 'admin' || role === 'super-admin');
                const plantsCount = await getUserPlantsCount(username);

                userData = {
                    id: 1,
                    username: username,
                    fullName: isSuperAdmin ? '超级管理员' : '用户 ' + username,
                    email: username + '@campus.edu',
                    phone: '13800138000',
                    department: isSuperAdmin ? '系统管理部' : '计算机学院',
                    studentId: isSuperAdmin ? 'ADMIN001' : '2023001001',
                    bio: isSuperAdmin ? '系统超级管理员，负责用户管理和系统维护。' : '热爱植物，喜欢探索校园中的各种植被。',
                    role: isSuperAdmin ? 'super-admin' : role,
                    avatar: '',
                    plantsAdded: plantsCount,
                    lastLogin: new Date().toLocaleDateString()
                };
            }

            // 如果是管理员或超级管理员，加载用户列表
            if (userData.role === 'admin' || userData.role === 'super-admin') {
                await loadUsersData();
            }

            // 更新用户信息显示
            updateUserInfo();

            // 检查权限并显示相应功能
            checkPermissions();
        } catch (error) {
            console.error('加载用户数据失败:', error);
        }
    }

    // 修改加载用户列表的函数
    async function loadUsersData() {
        try {
            usersData = await fetchAllUsers();
            loadUsersTable();
        } catch (error) {
            console.error('加载用户列表失败:', error);
            usersData = [];
        }
    }

    // 更新用户信息显示
    function updateUserInfo() {
        document.getElementById('userName').textContent = userData.fullName;
        document.getElementById('username').value = userData.username;
        document.getElementById('fullName').value = userData.fullName;
        document.getElementById('email').value = userData.email;
        document.getElementById('phone').value = userData.phone;
        document.getElementById('department').value = userData.department;
        document.getElementById('studentId').value = userData.studentId;
        document.getElementById('bio').value = userData.bio;
        document.getElementById('plantsAdded').textContent = userData.plantsAdded;
        document.getElementById('lastLogin').textContent = userData.lastLogin;

        // 更新角色徽章
        const roleBadge = document.getElementById('userRole');
        roleBadge.textContent = getRoleText(userData.role);
        roleBadge.className = 'role-badge ' + getRoleClass(userData.role);

        // 如果有头像，显示头像
        if (userData.avatar) {
            const avatarPreview = document.getElementById('avatarPreview');
            avatarPreview.innerHTML = '';
            const img = document.createElement('img');
            img.src = userData.avatar;
            img.className = 'avatar-preview';
            img.style.objectFit = 'cover';
            avatarPreview.appendChild(img);
        }
    }

    // 获取角色文本
    function getRoleText(role) {
        switch(role) {
            case 'super-admin': return '超级管理员';
            case 'admin': return '管理员';
            case 'user': return '普通用户';
            default: return '普通用户';
        }
    }

    // 获取角色CSS类
    function getRoleClass(role) {
        switch(role) {
            case 'super-admin': return 'role-super-admin';
            case 'admin': return 'role-admin';
            case 'user': return 'role-user';
            default: return 'role-user';
        }
    }

    // 设置标签页切换
    function setupTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有标签页的active类
                tabButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                // 添加当前标签页的active类
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab') + 'Tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
    }

    // 设置头像上传
    function setupAvatarUpload() {
        const avatarInput = document.getElementById('avatarInput');
        const avatarPreview = document.getElementById('avatarPreview');

        document.querySelector('.avatar-upload').addEventListener('click', function() {
            avatarInput.click();
        });

        avatarInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    // 清除原有内容
                    avatarPreview.innerHTML = '';

                    // 创建图片元素
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'avatar-preview';
                    img.style.objectFit = 'cover';

                    avatarPreview.appendChild(img);
                    userData.avatar = e.target.result;
                    showSuccessMessage('头像更新成功！');
                }

                reader.readAsDataURL(this.files[0]);
            }
        });
    }

    // 设置表单提交
    function setupForms() {
        // 个人信息表单
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                // 更新用户数据
                userData.fullName = document.getElementById('fullName').value;
                userData.email = document.getElementById('email').value;
                userData.phone = document.getElementById('phone').value;
                userData.department = document.getElementById('department').value;
                userData.studentId = document.getElementById('studentId').value;
                userData.bio = document.getElementById('bio').value;

                // 保存到Supabase
                await updateUserProfile(userData);

                // 更新显示
                document.getElementById('userName').textContent = userData.fullName;

                showSuccessMessage('个人信息更新成功！');
            } catch (error) {
                console.error('更新个人信息失败:', error);
                alert('更新失败，请稍后重试！');
            }
        });

        // 密码修改表单
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('新密码和确认密码不一致！');
                return;
            }

            if (newPassword.length < 8) {
                alert('密码长度至少8位！');
                return;
            }

            try {
                await updateUserPassword(userData.username, currentPassword, newPassword);
                showSuccessMessage('密码修改成功！');
                document.getElementById('passwordForm').reset();
            } catch (error) {
                alert(error.message || '密码修改失败！');
            }
        });

        // 添加用户表单
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const newUser = {
                    username: document.getElementById('newUsername').value,
                    fullName: document.getElementById('newFullName').value,
                    email: document.getElementById('newEmail').value,
                    password: document.getElementById('newPassword').value,
                    role: document.getElementById('newRole').value
                };

                await addNewUser(newUser);
                await loadUsersData();
                document.getElementById('addUserModal').classList.remove('active');
                document.getElementById('addUserForm').reset();
                showSuccessMessage('用户添加成功！');
            } catch (error) {
                console.error('添加用户失败:', error);
                alert(error.message || '添加用户失败，请稍后重试！');
            }
        });
    }

    // 设置按钮事件
    function setupButtons() {
        // 个人信息取消按钮
        document.getElementById('cancelProfile').addEventListener('click', function() {
            updateUserInfo();
        });

        // 密码修改取消按钮
        document.getElementById('cancelPassword').addEventListener('click', function() {
            document.getElementById('passwordForm').reset();
        });

        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userId');
                window.location.href = 'index.html';
            }
        });

        // 添加用户按钮
        document.getElementById('addUserBtn').addEventListener('click', function() {
            document.getElementById('addUserModal').classList.add('active');
        });

        // 关闭模态框
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('addUserModal').classList.remove('active');
        });

        document.getElementById('cancelAddUser').addEventListener('click', function() {
            document.getElementById('addUserModal').classList.remove('active');
            document.getElementById('addUserForm').reset();
        });
    }

    // 检查权限并显示相应功能
    function checkPermissions() {
        const adminTab = document.getElementById('adminTab');
        const addUserBtn = document.getElementById('addUserBtn');

        // 只有管理员才能看到用户管理功能
        if (userData.role === 'admin' || userData.role === 'super-admin') {
            adminTab.style.display = 'block';

            // 只有超级管理员可以添加用户
            if (userData.role === 'super-admin') {
                addUserBtn.style.display = 'block';
            } else {
                addUserBtn.style.display = 'none';
            }
        } else {
            adminTab.style.display = 'none';
        }
    }

    // 加载用户表格
    function loadUsersTable() {
        const tableBody = document.getElementById('userTableBody');
        tableBody.innerHTML = '';

        if (usersData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-gray-500">
                        暂无用户数据
                    </td>
                </tr>
            `;
            return;
        }

        usersData.forEach(user => {
            const row = document.createElement('tr');

            row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.full_name || '未设置'}</td>
                    <td>${user.email || '未设置'}</td>
                    <td><span class="role-badge ${getRoleClass(user.role)}">${getRoleText(user.role)}</span></td>
                    <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : '未知'}</td>
                    <td>
                        <div class="flex space-x-2">
                            ${user.role !== 'super-admin' ? `<button class="text-blue-600 hover:text-blue-800 text-sm edit-user" data-id="${user.id}">编辑</button>` : ''}
                            ${user.role === 'user' && userData.role === 'super-admin' ? `<button class="text-green-600 hover:text-green-800 text-sm promote-user" data-id="${user.id}">设为管理员</button>` : ''}
                            ${user.role !== 'super-admin' && user.id !== userData.id ? `<button class="text-red-600 hover:text-red-800 text-sm delete-user" data-id="${user.id}">删除</button>` : ''}
                        </div>
                    </td>
                `;

            tableBody.appendChild(row);
        });

        // 绑定用户操作事件
        document.querySelectorAll('.edit-user').forEach(button => {
            button.addEventListener('click', function() {
                const userId = parseInt(this.getAttribute('data-id'));
                editUser(userId);
            });
        });

        document.querySelectorAll('.promote-user').forEach(button => {
            button.addEventListener('click', function() {
                const userId = parseInt(this.getAttribute('data-id'));
                promoteUser(userId);
            });
        });

        document.querySelectorAll('.delete-user').forEach(button => {
            button.addEventListener('click', function() {
                const userId = parseInt(this.getAttribute('data-id'));
                deleteUser(userId);
            });
        });
    }

    // 编辑用户
    function editUser(userId) {
        const user = usersData.find(u => u.id === userId);
        if (user) {
            alert(`编辑用户: ${user.full_name} (${user.username})\n\n此功能正在开发中...`);
            // 在实际应用中，这里应该打开编辑用户的模态框
        }
    }

    // 提升用户为管理员
    async function promoteUser(userId) {
        if (confirm('确定要将此用户设为管理员吗？')) {
            try {
                await updateUserRole(userId, 'admin');
                await loadUsersData();
                const user = usersData.find(u => u.id === userId);
                showSuccessMessage(`已将 ${user.full_name} 设为管理员！`);
            } catch (error) {
                console.error('提升用户权限失败:', error);
                alert('操作失败，请稍后重试！');
            }
        }
    }

    // 删除用户
    async function deleteUser(userId) {
        if (confirm('确定要删除此用户吗？此操作不可恢复。')) {
            try {
                const user = usersData.find(u => u.id === userId);
                await deleteUserFromSupabase(userId);
                await loadUsersData();
                showSuccessMessage(`用户 ${user.full_name} 已删除！`);
            } catch (error) {
                console.error('删除用户失败:', error);
                alert('删除失败，请稍后重试！');
            }
        }
    }

    // 显示成功消息
    function showSuccessMessage(message) {
        const successMessage = document.getElementById('successMessage');
        document.getElementById('successText').textContent = message;

        successMessage.classList.add('show');

        setTimeout(() => {
            successMessage.classList.remove('show');
        }, 3000);
    }
</script>
</body>
</html>